# Default values for telco-cloud-init.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# generic helm chart release name overrides
nameOverride: ""
fullnameOverride: ""

# registry secrets
registry_secret:
  registry.gitlab.com:
    username: your_user_name
    password: glpat-XXXXX

# repository secrets
git_auth_default:
  username: your_user_name
  password: glpat-XXXXX

git_repo_spec_default:
  interval: 60m0s
  gitImplementation: libgit2

git_repo_templates: # template to generate Flux GitRepository resources
  # <repo-name>:
  #   # auth: # can be used to override git_auth_default
  #   #   username: plop
  #   #   password: flop
  #   spec:  # partial spec for a Flux GitRepository
  #     url: https://gitlab.com/t6306/components/capi-bootstrap.git
  #     #secretRef: # is autogenerated based on 'auth' or 'git_auth_default'
  #     ref: # can be overridden per-component, with 'ref_override'
  #       branch: main

  capi-bootstrap:
    spec:
      url: https://gitlab.com/t6306/components/capi-bootstrap.git
      ref:
        # tag/commit will take precedence, see https://fluxcd.io/flux/components/source/api/#source.toolkit.fluxcd.io/v1beta2.GitRepositoryRef
        branch: develop

helm_repo_spec_default:
  interval: 60m0s


# this defines the default .spec for a Kustomization resource
# generated for each item of 'components'
component_kustomization_spec_default: # default .spec for a Kustomization
  force: false
  prune: true
  interval: 15m
  retryInterval: 1m
  wait: false
  timeout: 30s

# this defines the default .spec for a HelmRelease resource
# generated a component with a "helmrelease_spec" field
component_helmrelease_spec_default:  # default for the .spec of a HelmRelease
  interval: 15m
  install:
    remediation:
      retries: 10
      remediateLastFailure: true

# this defines the default .spec for a Kustomization resource containing the HelmRelease resource
# generated a component with a "helmrelease_spec" field
component_helmrelease_kustomization_spec_default:
  path: ./kustomize-components/helmrelease-generic
  sourceRef:
    kind: GitRepository
    name: capi-bootstrap  # GitRepository created by templates/gitrepository-self.yaml

  wait: true


# this defines Flux HelmRelease objects, and for each  # FIXME
# a corresponding GitRepository (and Secret, TODO: the Secret don't need to be generated for each component)
components:
  # <component-name>:
  #   enabled: yes/no/management-only
  #   repo: <name of the repo under 'git_repo_templates', defaults to 'default'>
  #   labels: (optional) dict holding labels to add to the resources for this component
  #   ref_override: optional, if defined, this dict will be used for the GitRepository overriding spec.ref (not used if some helm_repo_* is set)
  #   depends_on: list of '{name: component}' maps defining the dependencies of this component (this is injected in the component Kustomization as dependsOn field)
  #   helmrelease_spec:  # optionnal, contains a partial spec for a FluxCD HelmRelease, all the
  #                      # key things are generated from component_helmrelease_spec_default
  #                      # and from other fields in the component definition
  #   kustomization_spec:  # contains a partial spec for a FluxCD Kustomization, most of the
  #                        # things are generated from component_kustomization_spec_default
  #     # sourceRef is generated from .git_repo field
  #     path: ./path-to-component-under-repo
  #     # the final path will hence be:
  #     # - <git repo template>.spec.url + <component>.spec.path  (if <git repo template> has spec.url defined)

  flux-system:
    # note that Flux is always installed on the current cluster as a pre-requisite to installing the chart
    # this components contains Flux definitions *to manage the Flux system itself via gitops*

    repo: capi-bootstrap
    kustomization_spec:
      path: ./kustomize-components/flux-system
      targetNamespace: flux-system
      wait: true
      postBuild:
        substitute:
          var_substitution_enabled: "true" # To force substitution when configmap does not exist
        substituteFrom:
        - kind: ConfigMap
          name: proxy-env-vars
          optional: true

  kubed:
    use: no # need to enable for 'capd' provider
    # FIXME: maybe is isn't required any more with this helm chart, and we could create secrets in components namespaces?
    # We need kubed to copy secrets from namespace to namespace for the 'capd' provider
    # Unfortunately, it doesn't seems to be possible to pass registry secrets from default namespace to others without the use of an additionnal tool like this one:
    # - We can't use kustomize's secretGenerator to copy secret across namespaces, as secret value would be base64-encoded, thus flux PostBuild wouldn't be able to substitute it.
    # - Additionnaly, flux substituteFrom doesn't supports keys starting by a dot, so we can't susbstitute directly from docker-registry secret as the key is .dockerconfigjson
    # - And finally, if we manage to place this secret in another variable, substitution will fail as secret well be passed as a string, whereas .dockerconfigjson is supposed to contain a json...
    helm_repo_url: https://charts.appscode.com/stable
    helmrelease_spec:
      chart:
        spec:
          chart: kubed
          version: v0.13.2
      targetNamespace: kubed
      install:
        createNamespace: true
      values:
        installCRDs: true

  cert-manager:
    helm_repo_url: https://charts.jetstack.io
    helmrelease_spec:
      chart:
        spec:
          chart: cert-manager
          version: v1.8.2
      targetNamespace: cert-manager
      install:
        createNamespace: true
      values:
        installCRDs: true

  capi:
    # ref_override:  # test
    #   branch: i-really-need-dev-branch-foo
    repo: capi-bootstrap
    depends_on:
      - name: cert-manager
    kustomization_spec:
      path: ./kustomize-components/capi
      wait: true

  capd:
    enabled: no
    repo: capi-bootstrap
    depends_on:
      - name: cert-manager
    kustomization_spec:
      path: ./kustomize-components/capd
      postBuild:
        substituteFrom:
        - kind: ConfigMap
          name: cluster-vars
      wait: true

  capo:
    enabled: no
    repo: capi-bootstrap
    depends_on:
      - name: cert-manager
    kustomization_spec:
      path: ./kustomize-components/capo
      wait: true

  capm3:
    enabled: no
    repo: capi-bootstrap
    depends_on:
      - name: cert-manager
    kustomization_spec:
      path: ./kustomize-components/capm3
      wait: true

  capv:
    enabled: no
    repo: capi-bootstrap
    depends_on:
      - name: cert-manager
    kustomization_spec:
      path: ./kustomize-components/capv
      wait: true

  cabpk:
    enabled: no
    repo: capi-bootstrap
    depends_on:
      - name: cert-manager
    kustomization_spec:
      path: ./kustomize-components/cabpk
      wait: true

  cabpr:  # RKE2
    enabled: no
    repo: capi-bootstrap
    depends_on:
      - name: cert-manager
    kustomization_spec:
      path: ./kustomize-components/cabpr
      wait: true

  cluster-resource-sets:  # for now only needed for kubeadm
    enabled: no  ## we'll turn this to false once we deploy calico with Flux
    repo: capi-bootstrap
    depends_on:
      - name: capi  # is this the right dependency ?
    kustomization_spec:
      path: ./kustomize-components/cluster-resource-sets
      wait: true

  cluster:
    enabled: yes
    repo: capi-bootstrap
    depends_on:
      - name: capi
    labels:
      suspend-on-pivot: "yes"  # this component must be suspended before pivot
    kustomization_spec:
      # see note below under .cluster
      # the choice made here, for now, requires setting other values consistently under .cluster.xxx
      path: ./kustomize-components/management-cluster/_override_me_/base
      postBuild:
        substituteFrom:
        - kind: ConfigMap
          name: cluster-vars
      healthChecks:
        - apiVersion: cluster.x-k8s.io/v1beta1
          kind: Cluster
          name: management-cluster
          namespace: default

  rancher:
    enabled: no
    repo: capi-bootstrap
    depends_on:
      - name: cert-manager
      - name: k8s-gateway
    kustomization_spec:
      path: ./kustomize-components/rancher
      wait: true

  k8s-gateway:
    enabled: no
    repo: capi-bootstrap
    kustomization_spec:
      path: ./kustomize-components/k8s-gateway
      wait: true
      postBuild:
        substituteFrom:
        - kind: ConfigMap
          name: cluster-vars

  rancher-import:
    enabled: no
    repo: capi-bootstrap
    depends_on:
    - name: rancher
    - name: k8s-gateway
    kustomization_spec:
      path: ./kustomize-components/rancher-import
      wait: true
      patches:
      - target:
          kind: GitRepository
          name: capi-rancher-import
        patch: |
          - op: add
            path: /spec/secretRef/name
            # FIXME(baburciu): it's hardcoded, due to known format ./charts/telco-cloud-init/templates/components.yaml and component
            value: git-auth-repo-component-rancher-import
      - target:
          kind: HelmRelease
          name: capi-rancher-import
        patch: |
          - op: add
            path: /spec/values/conf/cattle_agent_kustomize_source/spec/secretRef/name
            # FIXME(baburciu): it's hardcoded, due to known format ./charts/telco-cloud-init/templates/components.yaml and component
            value: git-auth-repo-component-rancher-import              

  ingress-nginx:
    enabled: no
    repo: capi-bootstrap
    kustomization_spec:
      path: ./kustomize-components/ingress-nginx
      wait: true

## stuff related to the 'cluster' component

cluster:
  name: management-cluster
  # TODO: derive kubeconfig secret name from this ^

  # image reference depends provider
  image: registry.gitlab.com/t6306/components/docker-images/rke2-in-docker:v1-24-4-rke2r1

  # for now, the choice below needs to be made
  # consistently with the choice of a matching kustomization path
  # for the 'cluster' component
  # e.g. you can use ./management-cluster-def/rke2-capd
  flavor:
    infra_provider: capd   # capo
    bootstrap_provider: cabpr  # RKE2 or kubeadm

  capo:
    ssh_key_name:
    image: capo-ubuntu-2004-kube-v1.23.6-calico-3.23.1
    network_id:  # openstack network to use as external network
    clouds_yaml: # (this is a dict, not a YAML string)
    #cacert: # cert used to validate CA of OpenStack APIs
    kube_vip_ip: 55.55.55.55

capd:
  docker_host: unix:///var/run/docker.sock

# debug_values can be used to see how flux merged helm release values in telco-cloud-init-values-debug secret:
# kubectl get secrets telco-cloud-init-values-debug -o template="{{ .data.values }}" | base64 -d
debug_values: no


# 'phase' determines whether we are instantiating this chart
# on the bootstrap cluster or on the management cluster
#
# this is used to determine which component manifests to generate
# for a given item under 'components':
# if 'enabled' is set to 'management-only' then the component is enabled only if 'phase: management'
phase: management

component_default_enable: management-only  # this simply ensures that adding a component in this file under components does not implicitly enable it for "bootstrap"
