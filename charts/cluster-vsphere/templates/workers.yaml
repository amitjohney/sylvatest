{{- $outer := . }}
{{ range $workerName, $workerPool := .Values.machines.workers }}
{{- with $outer }}
{{- $templatePrefix := printf "%s-%s" (include "cluster-api-vsphere.clusterName" .) $workerName }}
{{$workersData := dict "Values" .Values "templateValues" $workerPool "templatePrefix" $templatePrefix "Release" .Release}}
---
apiVersion: cluster.x-k8s.io/v1beta1
kind: MachineDeployment
metadata:
  annotations: 
  {{- if include "cluster-api-vsphere.annotations" . }}
  {{- include "cluster-api-vsphere.annotations" . | nindent 4 }}
  {{- end }}
  {{- if (index .Values.machines.workers $workerName).machineDeploymentAnnotations }}
  {{- toYaml (index .Values.machines.workers $workerName).machineDeploymentAnnotations | nindent 4 }}
  {{- end }}
  labels:
    cluster.x-k8s.io/cluster-name: {{ include "cluster-api-vsphere.clusterName" . }}
    {{- include "cluster-api-vsphere.labels" . | nindent 4 }}
  name: {{ include "cluster-api-vsphere.clusterName" . }}-{{ $workerName }}
  namespace: {{ .Release.Namespace | quote }}
spec:
  clusterName: {{ include "cluster-api-vsphere.clusterName" . }}
  replicas: {{ $workerPool.replicas }}
  selector:
    matchLabels: {{ toYaml (index .Values.machines.workers $workerName).machinesSelectors | nindent 6 }}
  template:
    metadata:
      labels:
        cluster.x-k8s.io/cluster-name: {{ include "cluster-api-vsphere.clusterName" . }}
        {{- if (index .Values.machines.workers $workerName).machinesLabels }}
        {{- toYaml (index .Values.machines.workers $workerName).machinesLabels | nindent 8 }}
        {{- end }}
    spec:
      bootstrap:
        configRef:
          apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
          kind: KubeadmConfigTemplate
          name: {{ include "cluster-api-vsphere.KubeadmConfigTemplateName" $workersData }}
      clusterName: {{ include "cluster-api-vsphere.clusterName" . }}
      {{- if (index .Values.machines.workers $workerName).nodeDrainTimeout }}
      nodeDrainTimeout: {{ (index .Values.machines.workers $workerName).nodeDrainTimeout }}
      {{- end }}
      infrastructureRef:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: VSphereMachineTemplate
        name: {{ include "cluster-api-vsphere.VSphereMachineTemplateName" $workersData }}
      version: {{ .Values.kubernetes.version }}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: VSphereMachineTemplate
metadata:
  labels:
    {{- include "cluster-api-vsphere.labels" . | nindent 4 }}
  name: {{ include "cluster-api-vsphere.VSphereMachineTemplateName" $workersData }}
  namespace: {{ .Release.Namespace | quote }}
  annotations:
    helm.sh/resource-policy: keep
    {{- if include "cluster-api-vsphere.annotations" . }}
      {{- include "cluster-api-vsphere.annotations" . | nindent 4 }}
    {{- end }}
spec:  {{- include "cluster-api-vsphere.VSphereMachineTemplate" $workersData | nindent 2 }}
---
apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
kind: KubeadmConfigTemplate
metadata:
  annotations:
    helm.sh/resource-policy: keep
  {{- if include "cluster-api-vsphere.annotations" . }}
    {{- include "cluster-api-vsphere.annotations" . | nindent 4 }}
  {{- end }}
  labels:
    {{- include "cluster-api-vsphere.labels" . | nindent 4 }}
  name: {{ include "cluster-api-vsphere.KubeadmConfigTemplateName" $workersData }}
  namespace: {{ .Release.Namespace | quote }}
spec: {{- include "cluster-api-vsphere.KubeadmConfigTemplate" $workersData | nindent 2 }}
{{- end }}
{{- end }}

