{{/* This GitRepository is referred to from 'unit_helmrelease_kustomization_spec_default' */}}
{{- $envAll := set . "Values" (include "interpret-values-gotpl" . | fromJson) -}}
{{- $repo_name := "sylva-core" -}}
{{- if not (hasKey (index .Values.source_templates "sylva-core") "existing_gitrepository") -}}
    {{- $unit_name := "sylva-core" -}}
    {{- $repo_def := deepCopy (index $envAll.Values.source_templates $repo_name) -}}
    {{- $auth := $repo_def.auth | default $envAll.Values.git_auth_default -}}
---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: GitRepository 
metadata:
  name: sylva-core
  labels:
{{ include "sylva-units.labels" $envAll | indent 4 }}
spec:
    {{ $secret_ref := dict "secretRef" (dict "name" "git-repo-auth-sylva-core") -}}
    {{- $spec := dict -}}
    {{- $spec = mergeOverwrite $spec $envAll.Values.git_repo_spec_default $repo_def.spec $secret_ref -}}
    {{- if not (hasKey $spec "url") -}}
        {{- if not (hasKey $repo_def "base_url") -}}
            {{- fail (printf "repository template '%s' has neither '.spec.url' nor '.base_url' defined" $repo_name) -}}
        {{- end -}}
        {{- $_ := set $spec "url" (printf "%s/%s.git" $repo_def.base_url $unit_name) -}}
    {{- else if hasKey $repo_def "base_url" -}}
        {{- fail (printf "repository template '%s' has both '.spec.url' and '.base_url' defined" $repo_name) -}}
    {{- end }}
{{ $spec | toYaml | indent 2 }}
{{- end -}}
