{{- $envAll := set . "Values" (include "interpret-values-gotpl" . | fromJson) -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: os-images-info
  labels:
{{ include "sylva-units.labels" . | indent 4 }}
data:
  values.yaml: |
    os_images:
    {{- $sylva_dib_images := $envAll.Values.sylva_diskimagebuilder_images }}
    {{- $sylva_dib_images_format := $envAll.Values.sylva_diskimagebuilder_images_format }}
    {{- $sylva_dib_version := $envAll.Values.sylva_diskimagebuilder_version }}
    {{- $sylva_base_oci_registry := (tuple . $envAll.Values.sylva_base_oci_registry | include "interpret-as-string") }}
    {{- if ($envAll.Values.os_images) }}
      {{- range $os_image_name, $os_image_props := $envAll.Values.os_images }}
      {{ $os_image_name }}:
        {{- range $prop_key, $prop_value := $os_image_props }}
        {{ $prop_key }}: {{ $prop_value | quote }}
        {{- end }}
      {{- end }}
      {{- range $os_image_name, $os_image_props := $sylva_dib_images }}
        {{- if ($os_image_props.enabled) }}
      {{ $os_image_name }}:
        uri: {{ $sylva_base_oci_registry }}/sylva-elements/diskimage-builder/{{ $os_image_name }}:{{ $sylva_dib_version }}
        filename: {{ $os_image_name }}.{{ $sylva_dib_images_format }}
        {{- end }}
      {{- end }}
    {{- else }}
      {{- range $os_image_name, $os_image_props := $sylva_dib_images }}
        {{- if (or ($os_image_props.enabled) ($os_image_props.default_enabled)) }}
      {{ $os_image_name }}:
        uri: {{ $sylva_base_oci_registry }}/sylva-elements/diskimage-builder/{{ $os_image_name }}:{{ $sylva_dib_version }}
        filename: {{ $os_image_name }}.{{ $sylva_dib_images_format }}
        {{- end }}
      {{- end }}
    {{- end }}
