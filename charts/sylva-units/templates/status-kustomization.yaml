{{/*

sylva-units-status is a special Kustomization that depends on all other Kustomization
produced by the chart. Hence looking at its status allows to tell if all units have been deployed.

*/}}
{{- $envAll := set . "Values" (include "interpret-values-gotpl" . | fromJson) -}}
{{- $deps := list -}}
{{- range $unit_name, $unit_def := $envAll.Values.units -}}
  {{- if include "unit-enabled" (tuple $envAll $unit_name) -}}
    {{- $deps = append $deps (dict "name" $unit_name) -}}
  {{- end -}}
{{- end -}}
{{- $kustomization_spec := dict -}}
{{- $kustomization_spec = mergeOverwrite $envAll.Values.unit_kustomization_spec_default $envAll.Values.status_unit_kustomization_spec_default (dict "dependsOn" $deps) }}
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: sylva-units-status
  labels: {{ include "sylva-units.labels" $envAll | nindent 4 }}
spec:
{{ $kustomization_spec | toYaml | indent 2 }}
