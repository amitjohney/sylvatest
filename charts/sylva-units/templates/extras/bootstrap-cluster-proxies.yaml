{{/*

This template is used to export proxy env vars during bootstrap cluster install
following .cluster.proxies sylva-units values used to configure management cluster
(defined in environment-values/x/values.yaml).

For the bootstrap cluster, the stack operator is expected to provide the **proxies**
environment variables (http_proxy, https_proxy, no_proxy) if using corporate proxy,
these vars end up in Flux controllers proxy variables patching
(in ../../../../kustomize-units/flux-system/components/common/kustomization.yaml)

This template will generate a shell script that can export the proxy variables.
In order to generate a valid yaml, it will be stored in the 'script' key. In order to generate it,
you can call helm with following commandzs

helm template bootstrap-cluster-proxies charts/sylva-units --show-only templates/extras/bootstrap-cluster-proxies.yaml --values your-environment/proxies.yaml

*/}}

{{- if (eq .Release.Name "bootstrap-cluster-proxies") -}}

script: |-
  #!/bin/bash
  {{ $httpProxy := get .Values.proxies "http_proxy" | default "" -}}
  {{ $httpsProxy := get .Values.proxies "https_proxy" | default "" -}}
  {{ $noProxy := include "sylva-units.no_proxy" (tuple .) -}}

  export http_proxy=${http_proxy:-{{ $httpProxy }}}
  export https_proxy=${https_proxy:-{{ $httpsProxy }}}
  export no_proxy=${no_proxy:-{{ $noProxy }}}
{{- end -}}