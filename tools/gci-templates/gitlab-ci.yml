---
image: registry.gitlab.com/sylva-projects/sylva-elements/container-images/ci-image:v1.0.7

default:
  before_script:
    - chart_dir=charts/${HELM_NAME}
    # we replace 'helm' by a wrapper ignoring the warnings about symlinks
    - |
      function helm() { $(which helm) $@ 2> >(grep -v 'found symbolic link' >&2); }

.helm-lint:
  script:
    - helm lint $chart_dir

.helm-yamllint:
  script:
    - yamllint $chart_dir -d "$(cat < tools/gci-templates/configuration/yamllint.yaml) $(cat < tools/gci-templates/configuration/yamllint-helm-exclude-chart-templates.yaml)"

.helm-template-yamllint:
  script:
    - tools/gci-templates/scripts/helm-template-yamllint.sh

.helm-schema-validation:
  script:
    - tools/gci-templates/scripts/helm-schema-validation.sh

.kustomize-build:
  script:
    - kubectl kustomize ${KUSTOMIZATION_PATH}

.kube-score:
  script:
    - wget -q --show-progress --progress=bar:force https://github.com/zegl/kube-score/releases/download/v1.17.0/kube-score_1.17.0_linux_arm64 -O /usr/local/bin/kube-score
    - chmod +x /usr/local/bin/kube-score
    - kubectl kustomize ${KUSTOMIZATION_PATH} | kube-score score -
