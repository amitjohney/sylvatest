stages:
  - generate
  - test
  - deploy
  - delete

default:
  tags:
    - gitlab-org-docker
    # - docker
  image: registry.gitlab.com/sylva-projects/sylva-elements/container-images/ci-image:v1-0-2
  services:
    - name: docker:dind
      alias: docker

variables:
  DOCKER_TLS_CERTDIR: ""
  GITLEAKS_ARGS: '--verbose --log-opts=$CI_COMMIT_SHA'
  DOCKER_HOST: tcp://docker:2375/

# included templates
include:
  # Gitleaks template
  - project: "to-be-continuous/gitleaks"
    ref: 2.1.1
    file: "templates/gitlab-ci-gitleaks.yml"

chart-generator:
  stage: generate
  script:
    - echo "Generate CI jobs for each modified charts/units/environment-values"
    - ./tools/gci-templates/scripts/generate-pipeline.sh > generated-pipeline.yml
  artifacts:
    expire_in: 1 hour
    paths:
      - generated-pipeline.yml
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - charts/**/*
        - kustomize-units/**/*
        - environment-values/**/*
        - tools/gci-templates/**/*

chart-jobs:
  stage: generate
  needs:
    - chart-generator
  trigger:
    include:
      - artifact: generated-pipeline.yml
        job: chart-generator
    strategy: depend
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - charts/**/*
        - kustomize-units/**/*
        - environment-values/**/*
        - tools/gci-templates/**/*
        - tools/yaml2json.py

yamllint:
  stage: test
  script:
    - 'yamllint . -d "$(cat < tools/gci-templates/yamllint.yaml) $(cat < tools/gci-templates/yamllint-helm-exclude-charts.yaml)"'
  only:
    - merge_requests

avoid-typo-on-bootstrap:
  stage: test
  script:
    - |
      rm -rf .git  # because busybox grep does not support --exclude-dir
      echo "Check against frequent typos on 'bootstrap'..."
      set +e
      typos=$(grep -rnsiE 'boostrap|bootrap|bootsrap' . | grep -v '.gitlab-ci.yaml:      typos=')
      set -e
      if [ -n "$typos" ]; then
        echo "A few typos were found on the 'bootstrap' word:"
        echo "-----------------"
        echo "$typos"
        echo "-----------------"
        exit 1
      fi
  only:
    - merge_requests

check-docs-markdown:
  image: registry.gitlab.com/gitlab-org/gitlab-docs/lint-markdown:alpine-3.16-vale-2.20.2-markdownlint-0.32.2-markdownlint2-0.5.1
  stage: test
  script:
    - git fetch origin $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - |
      md_files=$(git diff --name-only $CI_COMMIT_SHA origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME | grep "\.md$" || true)
      if [ -n "$md_files" ] ; then
        markdownlint-cli2-config tools/gci-templates/.markdownlint.yml $md_files
      else
        echo "No modified .md files"
      fi
  only:
    refs:
      - merge_requests
    changes:
      - "**/*.md"

.common-capd:
  script:
    - echo -e "\e[1m\e[0Ksection_start:`date +%s`:gitlab_ci_prepare[collapsed=true]\r\e[0KRunning .gitlab-ci script step\e[0m"

    - DOCKER_IP=$(getent hosts docker | awk '{print $1}')
    - |
      # create a cluster with access to API endpoint through docker-in-docker address
      cat <<EOF | kind create cluster --name capd --config=-
      kind: Cluster
      apiVersion: kind.x-k8s.io/v1alpha4
      networking:
        apiServerAddress: "$DOCKER_IP"
        apiServerPort: 6443
      EOF
    - kubectl cluster-info --context kind-capd

    - KIND_PREFIX=$(docker network inspect kind -f '{{ (index .IPAM.Config 0).Subnet }}')
    - ip route add $KIND_PREFIX via $DOCKER_IP

    - export DOCKER_HOST=tcp://$DOCKER_IP:2375
    - values_file=environment-values/${ENV_NAME}/values.yaml
    - yq -i '.cluster.capd.docker_host = strenv(DOCKER_HOST)' $values_file
    - export CLUSTER_EXTERNAL_IP=$(echo $KIND_PREFIX | awk -F"." '{print $1"."$2"."$3".100"}')
    - yq -i '.cluster.cluster_external_ip = strenv(CLUSTER_EXTERNAL_IP)' $values_file
    - if [[ -n $DOCKERIO_REGISTRY_MIRROR ]]; then yq -i '.dockerio_registry_mirror = strenv(DOCKERIO_REGISTRY_MIRROR)' $values_file; fi
    # for now, some units don't work on generic workers
    # (see https://gitlab.com/sylva-projects/sylva-core/-/issues/2)
    - |
      if [[ ! $CI_RUNNER_TAGS =~ ".*capd-bm.*" ]]; then
        echo "disable some units to allow capd jobs to run on generic gitlab runners"
        yq -i '.units.workload-cluster.enabled=false' $values_file
        yq -i '.units.workload-cluster-calico.enabled=false' $values_file
        yq -i '.units.monitoring.enabled=false' $values_file
        yq -i '.units.keycloak.enabled=false' $values_file
        yq -i '.units.flux-webui.enabled=false' $values_file
        yq -i '.units.capi-rancher-import.enabled=false' $values_file
      fi
    - export DEBUG_ON_EXIT=1
    - echo -e "\e[0Ksection_end:`date +%s`:gitlab_ci_prepare\r\e[0K"
  artifacts:
    when: on_failure
    expire_in: 6 hour
    paths:
      - debug-on-exit.log
      - bootstrap-cluster-dump/
      - management-cluster-dump/
      - bootstrap-cluster-units-report.xml
      - management-cluster-units-report.xml
    reports:
      junit:
      - bootstrap-cluster-units-report.xml
      - management-cluster-units-report.xml

.test-capd:
  stage: deploy
  script:
    - !reference [.common-capd, script]
    - ./bootstrap.sh environment-values/${ENV_NAME}
    - kubectl --kubeconfig management-cluster-kubeconfig get pod --selector job-name=check-rancher-clusters-job -o=jsonpath='{.items[?(@.status.phase=="Succeeded")].metadata.name}' | xargs --no-run-if-empty -n1 kubectl --kubeconfig management-cluster-kubeconfig logs || true
  artifacts: !reference [.common-capd, artifacts]
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
    - if: $CI_MERGE_REQUEST_LABELS =~ /run-e2e-tests/
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual
  allow_failure: true

.test-preview-capd:
  stage: deploy
  timeout: 15min
  script:
    - !reference [.common-capd, script]
    - ./preview.sh environment-values/${ENV_NAME}
  artifacts: !reference [.common-capd, artifacts]
  variables:
    ENV_NAME: kubeadm-capd

test-kubeadm-capd:
  timeout: 45min
  extends: .test-capd
  variables:
    ENV_NAME: kubeadm-capd

.test-capo:
  stage: deploy
  before_script:
    - echo -e "\e[1m\e[0Ksection_start:`date +%s`:before_script_section[collapsed=true]\r\e[0KRunning before_script step\e[0m"

    - DOCKER_IP=$(getent hosts docker | awk '{print $1}')
    - |
      # create a cluster with access to API endpoint through docker-in-docker address
      cat <<EOF | kind create cluster --name capo --config=-
      kind: Cluster
      apiVersion: kind.x-k8s.io/v1alpha4
      networking:
        apiServerAddress: "$DOCKER_IP"
        apiServerPort: 6443
      EOF
    - kubectl cluster-info --context kind-capo

    - KIND_PREFIX=$(docker network inspect kind -f '{{ (index .IPAM.Config 0).Subnet }}')
    - ip route add $KIND_PREFIX via $DOCKER_IP

    # the OS_* variables below are set in the gitlab runner configuration
    # and contain information to connect to the OpenStack instance used
    # by this test
    - |
      cat <<EOF>> clouds.yml
      clouds:
        capo_cloud:
          auth:
            auth_url: '${OS_AUTH_URL}'
            user_domain_name: '${OS_USER_DOMAIN_ID}'
            project_domain_name: '${OS_PROJECT_DOMAIN_ID}'
            project_name: '${OS_TENANT_NAME}'
            username: '${OS_USERNAME}'
            password: '${OS_PASSWORD}'
            region: '${OS_REGION_NAME}'
          verify: false
      EOF
    - yq -i eval-all 'select(fileIndex==0).cluster.capo.clouds_yaml = select(fileIndex==1) | select(fileIndex==0)' environment-values/${ENV_NAME}/secrets.yaml clouds.yml
    - if [[ -n $OS_DOCKERIO_REGISTRY_MIRROR ]]; then yq -i '.dockerio_registry_mirror = strenv(OS_DOCKERIO_REGISTRY_MIRROR)' environment-values/$ENV_NAME/values.yaml; fi
    - export CAPO_TAG="${CI_PIPELINE_ID}-${ENV_NAME}"
    - yq -i '.cluster.capo.resources_tag = strenv(CAPO_TAG)' environment-values/$ENV_NAME/values.yaml
    - yq -i '.env_type_ci = true' environment-values/$ENV_NAME/values.yaml

    - export DEBUG_ON_EXIT=1

    - echo -e "\e[0Ksection_end:`date +%s`:before_script_section\r\e[0K"
  script:
    - git config --global credential.helper cache
    # the CI_COMPONENT_* variables below are set in the gitlab runner configuration
    # and allow to enable extra kustomize components needed in the context of the platform
    # on which this test actually runs
    - git clone --depth=1 https://foo:${CI_COMPONENT_REPO_PAT}@${CI_COMPONENT_REPO}
    - export CI_COMPONENT="https://${CI_COMPONENT_REPO}//sylva-core-ci/falcon-${ENV_NAME}?ref=sylva-capo-ci-upstream"
    - if [ $(yq '.components | length' environment-values/$ENV_NAME/kustomization.yaml) -eq "0" ]; then yq -i '.components = []' environment-values/$ENV_NAME/kustomization.yaml; fi
    - yq -i '.components += strenv(CI_COMPONENT)' environment-values/$ENV_NAME/kustomization.yaml
    - ./bootstrap.sh environment-values/${ENV_NAME}
    - kubectl --kubeconfig management-cluster-kubeconfig get pod --selector job-name=check-rancher-clusters-job -o=jsonpath='{.items[?(@.status.phase=="Succeeded")].metadata.name}' | xargs --no-run-if-empty -n1 kubectl --kubeconfig management-cluster-kubeconfig logs || true
  artifacts:
    when: on_failure
    expire_in: 6 hour
    paths:
      - debug-on-exit.log
      - bootstrap-cluster-dump/
      - management-cluster-dump/
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
    - if: $CI_MERGE_REQUEST_LABELS =~ /run-e2e-tests/
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual
  allow_failure: true
  tags:
    - falcon

test-rke2-capo:
  timeout: 75min
  extends: .test-capo
  variables:
    ENV_NAME: "rke2-capo"
  resource_group: test-rke2-capo-falcon

test-kubeadm-capo:
  timeout: 60min
  extends: .test-capo
  variables:
    ENV_NAME: "kubeadm-capo"
  resource_group: test-kubeadm-capo-falcon

.cleanup-capo:
  stage: delete
  image:
    name: registry.gitlab.com/t6306/components/docker-images/ci-image:openstack-client-v1.0
  script:
    - mkdir -p ~/.config/openstack
    - |
      cat <<EOF>> ~/.config/openstack/clouds.yml
      clouds:
        capo_cloud:
          auth:
            auth_url: '${OS_AUTH_URL}'
            user_domain_name: '${OS_USER_DOMAIN_ID}'
            project_domain_name: '${OS_PROJECT_DOMAIN_ID}'
            project_name: '${OS_TENANT_NAME}'
            username: '${OS_USERNAME}'
            password: '${OS_PASSWORD}'
          verify: false
      EOF
    - sh ./tools/openstack-cleanup.sh capo_cloud "${CI_PIPELINE_ID}-${ENV_NAME}"
  tags:
    - falcon

cleanup-rke2-capo:
  extends: .cleanup-capo
  variables:
    ENV_NAME: "rke2-capo"
  needs:
    - test-rke2-capo

cleanup-kubeadm-capo:
  extends: .cleanup-capo
  variables:
    ENV_NAME: "kubeadm-capo"
  needs:
    - test-kubeadm-capo
