# https://github.com/rancher/charts/blob/release-v2.8/charts/rancher-logging/3.15.0/templates/loggings/rke2/configmap.yam
kind: ConfigMap
metadata:
  name: logging-rke2
  namespace: cattle-logging-system
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush             1
        Grace             5
        Daemon            Off
        Log_Level         info
        Coro_Stack_Size   24576
        Parsers_File      parsers.conf

    [INPUT]
        Name              systemd
        Tag               rke2
        Path              /run/log/journal
        Systemd_Filter    _SYSTEMD_UNIT=rke2-server.service
        Systemd_Filter    _SYSTEMD_UNIT=rke2-agent.service

    [INPUT]
        Name              tail
        Tag               rke2
        Path              /var/lib/rancher/rke2/agent/logs/kubelet.log

    [FILTER]
        Name              parser
        Match             *
        Key_Name          log
        Parser            klog
        Reserve_Data      On

    [FILTER]
        Name              parser
        Match             *
        Key_Name          MESSAGE
        Parser            klog
        Reserve_Data      On

    [FILTER]
        Name              parser
        Match             *
        Key_Name          MESSAGE
        Parser            rancher
        Reserve_Data      On

    [FILTER]
        Name              parser
        Match             *
        Key_Name          MESSAGE
        Parser            etcd
        Reserve_Data      On

    [OUTPUT]
        Name              forward
        Match             *
        Host              ${RELEASE_NAME}-root-fluentd.${NAMESPACE}.svc.cluster.local
        Port              24240
        Retry_Limit       False
  parsers.conf: |
    [PARSER]
        Name              klog
        Format            regex
        Regex             ^(?<level>[IWEF])(?<timestamp>\d{4} \d{2}:\d{2}:\d{2}).\d{6} +?(?<thread_id>\d+) (?<filename>.+):(?<linenumber>\d+)] (?<message>.+)
        Time_Key          timestamp
        Time_Format       %m%d %T

    [PARSER]
        Name              rancher
        Format            regex
        Regex             ^time="(?<timestamp>.+)" level=(?<level>.+) msg="(?<msg>.+)"$
        Time_Key          timestamp
        Time_Format       %FT%H:%M:%S
    [PARSER]
        Name              etcd
        Format            json
        Time_Key          timestamp
        Time_Format       %FT%H:%M:%S.%L
