---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: Metal3MachineTemplate
metadata:
  name: ${CLUSTER_NAME}-control-plane
  namespace: default
  labels:
    role: control-plane
spec:
  template:
    spec:
      dataTemplate:
        name: ${CLUSTER_NAME}-control-plane-template
      hostSelector:
        matchLabels:
          nodepool: control
      image:
        checksum: ${MACHINE_IMAGE_CHECKSUM}
        checksumType: md5
        format: qcow2
        url: ${MACHINE_IMAGE}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: Metal3DataTemplate
metadata:
  name: ${CLUSTER_NAME}-control-plane-template
  namespace: default
spec:
  clusterName: ${CLUSTER_NAME}
  metaData:
    ipAddressesFromIPPool:
    - key: provisioningIP
      name: provisioning-pool
    objectNames:
    - key: name
      object: machine
    - key: local-hostname
      object: machine
    - key: local_hostname
      object: machine
    prefixesFromIPPool:
    - key: provisioningCIDR
      name: provisioning-pool
    fromLabels:
    - key: longhorn
      object: baremetalhost
      label: longhorn
    fromAnnotations:
    - key: disk
      object: baremetalhost
      annotation: disk
  networkData:
    links:
      ethernets:
      - id: ens1f0
        macAddress:
          fromHostInterface: ens1f0
        type: phy
      - id: ens1f1
        macAddress:
          fromHostInterface: ens1f1
        type: phy
      bonds:
      - id: bond0
        bondLinks:
          - ens1f0
          - ens1f1
        bondMode: 802.3ad
        macAddress: {}
      vlans:
      - id: bond0.13
        vlanID: 13
        vlanLink: bond0
        macAddress:
          fromHostInterface: ens1f0
    networks:
      ipv4:
      - id: bond0
        ipAddressFromIPPool: provisioning-pool
        link: bond0
        routes:
        - gateway:
            fromIPPool: provisioning-pool
          network: ${PROVISIONING_POOL}
          prefix: ${PROVISIONING_POOL_PREFIX}
      - id: bond0.13
        ipAddressFromIPPool: public-pool
        link: bond0.13
        routes:
        - gateway:
            fromIPPool: public-pool
          network: 0.0.0.0
    services:
      dns:
      - ${DNS_SERVER}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: Metal3Cluster
metadata:
  name: ${CLUSTER_NAME}
  namespace: default
spec:
  controlPlaneEndpoint:
    host: ${CLUSTER_EXTERNAL_IP}
    port: 6443
  noCloudProvider: true
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: Metal3MachineTemplate
metadata:
  name: ${CLUSTER_NAME}-worker-basic
  namespace: default
  labels:
    role: worker-basic
spec:
  template:
    spec:
      dataTemplate:
        name: ${CLUSTER_NAME}-worker-basic-template
      hostSelector:
        matchLabels:
          nodepool: worker-basic
      image:
        checksum: ${MACHINE_IMAGE_CHECKSUM}
        checksumType: md5
        format: qcow2
        url: ${MACHINE_IMAGE}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: Metal3MachineTemplate
metadata:
  name: ${CLUSTER_NAME}-worker-sriov
  namespace: default
  labels:
    role: worker-sriov
spec:
  template:
    spec:
      dataTemplate:
        name: ${CLUSTER_NAME}-worker-sriov-template
      hostSelector:
        matchLabels:
          nodepool: worker-sriov
      image:
        checksum: ${MACHINE_IMAGE_CHECKSUM}
        checksumType: md5
        format: qcow2
        url: ${MACHINE_IMAGE}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: Metal3MachineTemplate
metadata:
  name: ${CLUSTER_NAME}-worker-intensive
  namespace: default
  labels:
    role: worker-intensive
spec:
  template:
    spec:
      dataTemplate:
        name: ${CLUSTER_NAME}-worker-intensive-template
      hostSelector:
        matchLabels:
          nodepool: worker-intensive
      image:
        checksum: ${MACHINE_IMAGE_CHECKSUM}
        checksumType: md5
        format: qcow2
        url: ${MACHINE_IMAGE}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: Metal3DataTemplate
metadata:
  name: ${CLUSTER_NAME}-worker-basic-template
  namespace: default
spec:
  clusterName: ${CLUSTER_NAME}
  metaData:
    ipAddressesFromIPPool:
    - key: provisioningIP
      name: provisioning-pool
    objectNames:
    - key: name
      object: machine
    - key: local-hostname
      object: machine
    - key: local_hostname
      object: machine
    prefixesFromIPPool:
    - key: provisioningCIDR
      name: provisioning-pool
    fromLabels:
    - key: longhorn
      object: baremetalhost
      label: longhorn
    fromAnnotations:
    - key: disk
      object: baremetalhost
      annotation: disk
  networkData:
    links:
      ethernets:
      - id: ens1f0
        macAddress:
          fromHostInterface: ens1f0
        type: phy
      - id: ens1f1
        macAddress:
          fromHostInterface: ens1f1
        type: phy
      bonds:
      - id: bond0
        bondLinks:
          - ens1f0
          - ens1f1
        bondMode: 802.3ad
        macAddress: {}
      vlans:
      - id: bond0.13
        vlanID: 13
        vlanLink: bond0
        macAddress:
          fromHostInterface: ens1f0
    networks:
      ipv4:
      - id: bond0
        ipAddressFromIPPool: provisioning-pool
        link: bond0
        routes:
        - gateway:
            fromIPPool: provisioning-pool
          network: ${PROVISIONING_POOL}
          prefix: ${PROVISIONING_POOL_PREFIX}
      - id: bond0.13
        ipAddressFromIPPool: public-pool
        link: bond0.13
        routes:
        - gateway:
            fromIPPool: public-pool
          network: 0.0.0.0
    services:
      dns:
      - ${DNS_SERVER}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: Metal3DataTemplate
metadata:
  name: ${CLUSTER_NAME}-worker-sriov-template
  namespace: default
spec:
  clusterName: ${CLUSTER_NAME}
  metaData:
    ipAddressesFromIPPool:
    - key: provisioningIP
      name: provisioning-pool
    objectNames:
    - key: name
      object: machine
    - key: local-hostname
      object: machine
    - key: local_hostname
      object: machine
    prefixesFromIPPool:
    - key: provisioningCIDR
      name: provisioning-pool
    fromLabels:
    - key: longhorn
      object: baremetalhost
      label: longhorn
  networkData:
    links:
      ethernets:
      - id: ens1f0
        macAddress:
          fromHostInterface: ens1f0
        type: phy
      - id: ens1f1
        macAddress:
          fromHostInterface: ens1f1
        type: phy
      bonds:
      - id: bond0
        bondLinks:
          - ens1f0
          - ens1f1
        bondMode: 802.3ad
        macAddress: {}
      vlans:
      - id: bond0.13
        vlanID: 13
        vlanLink: bond0
        macAddress:
          fromHostInterface: ens1f0
    networks:
      ipv4:
      - id: bond0
        ipAddressFromIPPool: provisioning-pool
        link: bond0
        routes:
        - gateway:
            fromIPPool: provisioning-pool
          network: ${PROVISIONING_POOL}
          prefix: ${PROVISIONING_POOL_PREFIX}
      - id: bond0.13
        ipAddressFromIPPool: public-pool
        link: bond0.13
        routes:
        - gateway:
            fromIPPool: public-pool
          network: 0.0.0.0
    services:
      dns:
      - ${DNS_SERVER}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: Metal3DataTemplate
metadata:
  name: ${CLUSTER_NAME}-worker-intensive-template
  namespace: default
spec:
  clusterName: ${CLUSTER_NAME}
  metaData:
    ipAddressesFromIPPool:
    - key: provisioningIP
      name: provisioning-pool
    objectNames:
    - key: name
      object: machine
    - key: local-hostname
      object: machine
    - key: local_hostname
      object: machine
    prefixesFromIPPool:
    - key: provisioningCIDR
      name: provisioning-pool
    fromLabels:
    - key: longhorn
      object: baremetalhost
      label: longhorn
  networkData:
    links:
      ethernets:
      - id: ens1f0
        macAddress:
          fromHostInterface: ens1f0
        type: phy
      - id: ens1f1
        macAddress:
          fromHostInterface: ens1f1
        type: phy
      bonds:
      - id: bond0
        bondLinks:
          - ens1f0
          - ens1f1
        bondMode: 802.3ad
        macAddress: {}
      vlans:
      - id: bond0.13
        vlanID: 13
        vlanLink: bond0
        macAddress:
          fromHostInterface: ens1f0
    networks:
      ipv4:
      - id: bond0
        ipAddressFromIPPool: provisioning-pool
        link: bond0
        routes:
        - gateway:
            fromIPPool: provisioning-pool
          network: ${PROVISIONING_POOL}
          prefix: ${PROVISIONING_POOL_PREFIX}
      - id: bond0.13
        ipAddressFromIPPool: public-pool
        link: bond0.13
        routes:
        - gateway:
            fromIPPool: public-pool
          network: 0.0.0.0
    services:
      dns:
      - ${DNS_SERVER}
---
apiVersion: ipam.metal3.io/v1alpha1
kind: IPPool
metadata:
  name: provisioning-pool
  namespace: default
spec:
  clusterName: ${CLUSTER_NAME}
  gateway: ${PROVISIONING_POOL_GATEWAY}
  namePrefix: ${CLUSTER_NAME}-prov
  pools:
  - end: ${PROVISIONING_POOL_END}
    start: ${PROVISIONING_POOL_START}
  prefix: ${PROVISIONING_POOL_PREFIX}
---
apiVersion: ipam.metal3.io/v1alpha1
kind: IPPool
metadata:
  name: public-pool
  namespace: default
spec:
  clusterName: ${CLUSTER_NAME}
  gateway: ${PUBLIC_POOL_GATEWAY}
  namePrefix: ${CLUSTER_NAME}-bmv4
  pools:
  - end: ${PUBLIC_POOL_END}
    start: ${PUBLIC_POOL_START}
  prefix: ${PUBLIC_POOL_PREFIX}