apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

patches:
- target:
    kind: KubeadmControlPlane
  patch: |-
    # Remove default mirroring configuration for k8s.gcr.io as it can't coexist with registry config dir
    - op: add
      path: /spec/kubeadmConfigSpec/preKubeadmCommands/-
      value: sed -i '/k8s.gcr.io/d' /etc/containerd/config.toml
    - op: add
      path: /spec/kubeadmConfigSpec/preKubeadmCommands/-
      value: grep -q config_path /etc/containerd/config.toml || echo "[plugins.\"io.containerd.grpc.v1.cri\".registry]\n  config_path = \"/etc/containerd/registry.d\"" >>  /etc/containerd/config.toml
    - op: add
      path: /spec/kubeadmConfigSpec/preKubeadmCommands/-
      value: systemctl restart containerd.service
    - op: add
      path: /spec/kubeadmConfigSpec/files/-
      value:
        path: /etc/containerd/registry.d/docker.io/hosts.toml
        owner: root
        permissions: "0644"
        content: |
          server = "https://docker.io"
          [host."${REGISTRY_MIRROR}"]
            capabilities = ["pull", "resolve"]
    # Replace k8s.gcr.io mirroring that was removed from default config.toml
    - op: add
      path: /spec/kubeadmConfigSpec/files/-
      value:
        path: /etc/containerd/registry.d/k8s.gcr.io/hosts.toml
        owner: root
        permissions: "0644"
        content: |
          server = "https://k8s.gcr.io"
          [host."https://registry.k8s.io"]
            capabilities = ["pull", "resolve"]
          [host."https://k8s.gcr.io"]
            capabilities = ["pull", "resolve"]
