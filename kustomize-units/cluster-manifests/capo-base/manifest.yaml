---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha5
kind: OpenStackMachineTemplate
metadata:
  name: ${CLUSTER_NAME}-control-plane
  labels:
    role: control-plane
spec:
  template:
    spec:
      cloudName: capo_cloud
      flavor: ${FLAVOR_NAME:=m1.large}
      identityRef:
        kind: Secret
        name: management-cluster-cloud-config
      image: ${MACHINE_IMAGE}
      sshKeyName: ${SSH_KEY_NAME}
      serverGroupID: ${CONTROL_PLANE_SERVERGROUP_ID}
      securityGroups:
        - name: default
        - name: ${CONTROL_PLANE_SECURITY_GROUP_NAME}
      ports:
        - network:
            id: ${CAPO_NETWORK_ID}
          allowedAddressPairs:
            - ipAddress: ${CLUSTER_EXTERNAL_IP}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha5
kind: OpenStackCluster
metadata:
  name: ${CLUSTER_NAME}
spec:
  cloudName: capo_cloud
  externalNetworkId: ${CAPO_NETWORK_ID}
  network:
    id: ${CAPO_NETWORK_ID}
  apiServerFixedIP: ${CLUSTER_EXTERNAL_IP}
  identityRef:
    kind: Secret
    name: management-cluster-cloud-config
  managedSecurityGroups: true
  disableAPIServerFloatingIP: true
  allowAllInClusterTraffic: true
  tags:
  - ${CAPO_TAG}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha5
kind: OpenStackMachineTemplate
metadata:
  name: ${CLUSTER_NAME}-worker
  labels:
    role: worker
spec:
  template:
    spec:
      cloudName: capo_cloud
      flavor: ${WORKER_FLAVOR_NAME:=m1.large}
      identityRef:
        kind: Secret
        name: management-cluster-cloud-config
      image: ${WORKER_MACHINE_IMAGE}
      sshKeyName: ${SSH_KEY_NAME}
      serverGroupID: ${WORKER_SERVERGROUP_ID}
      securityGroups:
      - name: default
      - name: ${WORKER_SECURITY_GROUP_NAME}
      ports:
        - network:
            id: ${CAPO_NETWORK_ID}
