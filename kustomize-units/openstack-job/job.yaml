apiVersion: v1
kind: Secret
metadata:
  name: cluster-cloud-config
data:
  cacert: ${CAPO_CACERT}
  clouds.yaml: ${CAPO_CLOUD_YAML}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: ${JOB_NAME}-${JOB_TARGET_NAMESPACE:-sylva-system}
spec:
  backoffLimit: ${backoffLimit:5}
  activeDeadlineSeconds: 1800
  template:
    spec:
      containers:
      - name: run-script
        image: registry.gitlab.com/sylva-projects/sylva-elements/container-images/openstack-client:v0.0.7
        command: ["/bin/sh", "-c", "/opt/openstack-job.sh"]
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          runAsNonRoot: true
          runAsUser: 1000
          privileged: false
          seccompProfile:
            type: RuntimeDefault
        env:
        - name: CLUSTER_TYPE
          value: ${CLUSTER_TYPE}
        - name: http_proxy
          value: ${httpProxy}
        - name: https_proxy
          value: ${httpsProxy}
        - name: no_proxy
          value: ${noProxy}
        - name: CLOUD
          value: ${CLOUD}
        volumeMounts:
        - name: script-volume
          mountPath: /opt/
          readOnly: true
        - name: openstack-config
          mountPath: /etc/openstack
          readOnly: true
      imagePullSecrets:
      - name: registry-secret
      restartPolicy: Never
      serviceAccountName: ${JOB_NAME}-${JOB_TARGET_NAMESPACE:-sylva-system}-sa
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      volumes:
      - name: script-volume
        configMap:
          name: openstack-job-script
          defaultMode: 0755
          items:
          - key: script
            path: ./openstack-job.sh
      - name: openstack-config
        secret:
          secretName: cluster-cloud-config

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ${JOB_NAME}-${JOB_TARGET_NAMESPACE:-sylva-system}-sa
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ${JOB_NAME}
rules: []
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ${JOB_NAME}
subjects:
- kind: ServiceAccount
  name: ${JOB_NAME}-${JOB_TARGET_NAMESPACE:-sylva-system}-sa
roleRef:
  kind: Role
  name: ${JOB_NAME}
  apiGroup: rbac.authorization.k8s.io
---
