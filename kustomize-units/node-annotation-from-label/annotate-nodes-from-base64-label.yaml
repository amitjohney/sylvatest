# the purpose of this policy is to add a node annotation from each item of a list of node labels
# like for example node.longhorn.io/default-disks-config=<base64> and node.longhorn.io/default-node-tags=<base64>
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: annotate-node-from-label-list
  annotations:
    policies.kyverno.io/title: Add Annotation to Nodes from Label with base64 value
    policies.kyverno.io/category: other
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Node, Label, Annotation
    kyverno.io/kyverno-version: v1.10.3
    policies.kyverno.io/minversion: 1.7.0
    kyverno.io/kubernetes-version: "1.23"
    policies.kyverno.io/description: >-
      Use the label set on a node and add an annotation for it
spec:
  mutateExistingOnPolicyUpdate: true
  rules:
    - name: annotate
      match:
        all:
        - resources:
            kinds:
            - Node
            selector:
              matchLabels:
                sylva.org/annotate-node-from-label: "true"  # needs to match cluster.rke2.nodeLabels
      context:
      - name: nodelabelprefix
        variable:
          value: '${NODE_LABEL_KEY_LIST}'
          # value:
          # - node.longhorn.io/default-disks-config
          # - node.longhorn.io/default-node-tags
          # or
          # value: '[]'
      mutate:
        targets:
        - apiVersion: v1
          kind: Node
          name: "{{ request.object.metadata.name }}"
        foreach:
        - list: "nodelabelprefix"
          context:
          - name: nodelabelvalues
            apiCall:
              urlPath: "/api/v1/nodes/{{request.object.metadata.name}}"
              jmesPath: items(metadata.labels,'key','value')[?starts_with(key, '{{element}}')][].value
              # $ kubectl get --raw /api/v1/nodes/management-cluster-cp-b803df8917-5rlt6 | jq | kubectl kyverno jp query "items(metadata.labels, 'key', 'value')[?starts_with(key, 'node.longhorn.io/default-disks-config')][].value"
          - name: nodelabelvaluesjoined
            variable:
              value: "{{ nodelabelvalues }}"
              jmesPath: join('', @)
          patchStrategicMerge:
            metadata:
              labels:
                sylva.org/annotate-node-from-label-done-by: "kyverno"
              annotations:
                "{{element}}": "{{ replace_all('{{nodelabelvaluesjoined}}', '-x', '=') | base64_decode(@) }}"
