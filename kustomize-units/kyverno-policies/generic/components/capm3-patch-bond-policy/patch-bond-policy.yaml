---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: patch-bond-policy
  namespace: sylva-system
  annotations:
    kustomize.toolkit.fluxcd.io/force: Enabled
    policies.kyverno.io/title: Patch metal3 networkdata to add bond_miimon option
    policies.kyverno.io/minversion: 1.12.0
spec:
  webhookConfiguration:
    matchConditions:
    - name: is-capi-infra-secret
      expression: "has(object.type) && object.type == 'infrastructure.cluster.x-k8s.io/secret'"
    - name: has-networkData
      expression: "has(object.data.networkData)"
  rules:
  - name: patch-bond-rule
    match:
      any:
      # Unfortunately we can't match any label as they are not present at secret creation
      - resources:
          kinds:
          - Secret
    context:
    - name: sourceData
      variable:
        value: "{{ base64_decode(request.object.data.networkData) | parse_yaml(@) }}"
    - name: patchedLinks
      variable:
        value: "{{ sourceData | [links[?type == 'bond'] | map(&merge(@,{bond_miimon: `100`}), @), links[?type != 'bond']][] }}"
    - name: networkData
      variable:
        value: "{{ merge(sourceData, {links: patchedLinks}) }}"
    mutate:
      patchStrategicMerge:
        data:
          networkData: "{{ networkData | to_string(@) | base64_encode(@) }}"
