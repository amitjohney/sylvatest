apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cluster-grub-secret
spec:
  generateExisting: true
  rules:
    # - name: generateSAVault
    #   match:
    #     any:
    #       - resources:
    #           kinds:
    #             - kustomize.toolkit.fluxcd.io/v1/Kustomization
    #           names:
    #             - cluster
    #   exclude:
    #     any:
    #     - resources:
    #         namespaces:
    #           - sylva-units-preview
    #   generate:
    #     synchronize: true
    #     apiVersion: v1
    #     kind: ServiceAccount
    #     data:
    #       metadata:
    #         name: "vault"
    #         namespace: "{{request.object.metadata.namespace}}"
    - name: generateRandomSecret
      match:
        any:
          - resources:
              kinds:
                - kustomize.toolkit.fluxcd.io/v1/Kustomization
              names:
                - cluster
      exclude:
        any:
        - resources:
            namespaces:
              - sylva-units-preview
      generate:
        synchronize: true
        apiVersion: redhatcop.redhat.io/v1alpha1
        kind: RandomSecret
        name: "cluster-grub-secret"
        namespace: "{{request.object.metadata.namespace}}"
        data:
          spec:
            connection:
              tLSConfig:
                skipVerify: true  # not cool but refering tlsSecret does not work in release v0.8.13 - see https://gitlab.com/sylva-projects/sylva-core/-/issues/261
                #  name: vault-tls
              address: https://vault.vault.svc.cluster.local:8200
            authentication:
              path: kubernetes
              role: secret-writer
              serviceAccount:
                name: vault
            isKVSecretsEngineV2: true
            path: "secret/data/{{request.object.metadata.namespace}}"
            secretKey: password
            secretFormat:
              passwordPolicyName: sylva-password-policy
