---
include:
  - local: .gitlab/ci/child-pipeline-default.yml
  - local: .gitlab/ci/templates-deployments.yml

# ----------------------------------------------------------
# Specific rules to run only
# deploy-management-cluster & cleanup
# used for eg by capo-fip-deploy, capo-misc-units-deploy

.rules:skip-if-only-deploy-mgmt:
  rules:
    - if: $ONLY_DEPLOY_MGMT
      when: never
    - when: on_success

.rules:run-if-only-deploy-mgmt:
  rules:
    - if: $ONLY_DEPLOY_MGMT

default:
  tags:
    - capo-ci
    - $CAPO_PLATFORM_TAG

# ----------------------------------------------------------

deploy-management-cluster:
  extends:
    - .deploy-management

# ----------------------------------------------------------

deploy-workload-cluster:
  extends:
    - .deploy-workload
    - .rules:skip-if-only-deploy-mgmt

# ----------------------------------------------------------

update-management-cluster:
  extends:
    - .update-management
    - .rules:skip-if-only-deploy-mgmt

# ----------------------------------------------------------

update-workload-cluster:
  extends:
    - .update-workload
    - .rules:skip-if-only-deploy-mgmt

# ----------------------------------------------------------

test-sso+workload-kubeconfig:
  extends:
    - .test-sso+workload-kubeconfig
    - .rules:skip-if-only-deploy-mgmt

test-no-sso+workload-kubeconfig:
  extends:
    - .test-no-sso+workload-kubeconfig
    - .rules:skip-if-only-deploy-mgmt

# ----------------------------------------------------------
test-sso:
  extends:
    - .test-sso
    - .rules:run-if-only-deploy-mgmt

test-login:
  extends:
    - .test-login

# ----------------------------------------------------------

cleanup-openstack:
  extends:
    - .cleanup-capo
  when: always
