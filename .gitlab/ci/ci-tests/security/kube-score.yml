---
# Perform a kubescore on cluster dump

.kube-score-base:
  stage: deployment-test
  script:
    - wget -q --show-progress --progress=bar:force https://github.com/zegl/kube-score/releases/download/v1.17.0/kube-score_1.17.0_linux_amd64 -O /usr/local/bin/kube-score
    - chmod +x /usr/local/bin/kube-score
    - ls -rlth
    - kube-score score $KUBE_SCORE_OPTIONS $DUMP_FOLDER/**.yaml | tee  ${DUMP_FOLDER}kube-score-results
    - ls -rtlh
    - cat ${DUMP_FOLDER}kube-score-results
  artifacts:
    expire_in: 6 hour
    paths:
      - ${DUMP_FOLDER}kube-score-results
  # To be removed
  allow_failure: true

kube-score-management-cluster:
  extends: .kube-score-base
  variables:
    DUMP_FOLDER: management-cluster-dump

kube-score-workload-cluster:
  extends: .kube-score-base
  variables:
    DUMP_FOLDER: workload-cluster-dump
