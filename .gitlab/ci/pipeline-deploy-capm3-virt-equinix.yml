---
include:
  - local: .gitlab/ci/deployment-pipeline.yml

# This configuration is specific to capm3-virt deployments
.flavored-pre-deployment-configuration:
  - echo -e "\e[1m\e[0Ksection_start:`date +%s`:gitlab_ci_capm3_virt[collapsed=true]\r\e[0KApplying specific capm3-virt configuration\e[0m"
  - echo "Using https://dashboard.stablebuild.com/organizations/sylvaproject/dockermirror as DockerHub registry_mirror"
  - |
    # The variable STABLE_BUILD_API_KEY below is set in gitlab CI/CD variables
    cat <<EOF>> /tmp/public_docker_registry_mirror.yml
    hosts_config:
      docker.io:
        - mirror_url: https://sylvaproject-${STABLE_BUILD_API_KEY}.dockermirror.stablebuild.com
    EOF
  - yq -i eval-all 'select(fileIndex==0).registry_mirrors = select(fileIndex==1) | select(fileIndex==0)' $ENV_PATH/values.yaml /tmp/public_docker_registry_mirror.yml
  - echo -e "\e[0Ksection_end:`date +%s`:gitlab_ci_capm3_virt\r\e[0K"

# Default tag will be used for all deployments/updates jobs
default:
  tags:
    - $CI_PIPELINE_IID
    - equinix
    - shell

# test-tags will be used to run the tests jobs in a docker executor based runner
.test-tags:
  tags:
    - $CI_PIPELINE_IID
    - equinix
    - docker

#----------------------------------------------------------

create-runner:
  stage: deploy
  timeout: 15min
  id_tokens:
    JOB_ID_TOKEN:
      aud: runner-aas
  variables:
    REQUEST: create
    RUNNER_HOSTNAME: syla-core-$CI_PIPELINE_ID
    RUNNER_TAG: $CI_PIPELINE_IID
    RUNNER_PROJECT_ID: $CI_PROJECT_ID
    RUNNER_PLAN: m3.small.x86
    RUNNER_AAS_TARGET_REF: main
  tags: []
  image:
    name: registry.gitlab.com/gitlab-org/cli:v1.39.0
    entrypoint: [""]
  script:
    - glab config set -g check_update false
    - >
      glab ci run-trig
      --token="$RUNNER_AAS_TOKEN"
      --branch "main"
      --variables "TARGET_REF:$RUNNER_AAS_TARGET_REF"
      --variables "REQUEST:$REQUEST"
      --variables "SOURCE_JWT_TOKEN:$JOB_ID_TOKEN"
      --variables "RUNNER_PLAN:$RUNNER_PLAN"
      --repo "sylva-projects/sylva-elements/ci-tooling/runner-aas-interface" | tee pipeline.json
    - 'PIPELINE_ID=$(grep -Eo "id: \d+" pipeline.json | grep -Eo "\d+")'
    - >
      while true; do
        PIPELINE=$(glab api projects/sylva-projects%2Fsylva-elements%2Fci-tooling%2Frunner-aas-interface/pipelines/$PIPELINE_ID)
        PIPELINE_STATUS=$(echo $PIPELINE | python3 -c 'import json,sys;print(json.load(sys.stdin)["status"])')
        echo "PIPELINE_STATUS = $PIPELINE_STATUS"
        [[ $PIPELINE_STATUS == "" ]] && exit 1
        [[ $PIPELINE_STATUS == "failed" ]] && exit 1
        [[ $PIPELINE_STATUS == "success" ]] && break
        sleep 5
      done

clean-runner:
  stage: cleanup
  extends: create-runner
  dependencies: []
  variables:
    REQUEST: delete
  when: always
