
# ==========================================
# Deploy stage
# ==========================================

include:
  - local: .gitlab/ci/templates-deployments.yml

variables:
  CAPO_PLATFORM_TAG: capo-ci
  # if a deploy job sets this to "even" (resp. "odd"), the job will automatically trigger
  # for any MR having an even MR number and the run-e2e-tests label
  E2E_JOB_MR_PARITY: any
  ENV_TAG: "${CI_PIPELINE_ID}-${ENV_NAME}"
  ENV_TAG_OCI: "${CI_PIPELINE_ID}-${ENV_NAME}-oci"
  KIND_CLUSTER_NAME: bootstrap-${ENV_TAG}
  MANAGEMENT_CLUSTER_NAME: mgmt-${ENV_TAG}
  WORKLOAD_CLUSTER_NAME: wc-${ENV_TAG}
  APPLY_VALUES_FILE: environment-values/ci/enable-multus.yml
  WC_APPLY_VALUES_FILE: environment-values/ci/enable-multus.yml
  DEPLOYMENT_FLAVOR:
    value: ""
    description: |
      Use for web or scheduled pipelines to select which deployments to run
      it can be the exact name of a job like "capd-kubeadm-deploy"
      or it can be a regex matching some deployment job. In this case
      the value need to be enclose with / like this
      "/capo-kubeadm/"

.deployment_rules:
  - if: $CI_MERGE_REQUEST_LABELS =~ /allow-ci-failure/
    # Bypass to allow some MR to be merged even if some tests are failing
    allow_failure: true
    when: manual
  - if: $CI_MERGE_REQUEST_LABELS =~ /renovate/ && $CAPO_TAG
    when: manual
  - if: '$CI_COMMIT_TAG'
  - if: $CI_PIPELINE_SOURCE == 'pipeline' && $OCI_TAG == null
    # Allow failure to not block MR in upstream repo
    allow_failure: true
    when: manual
  - if: '$CI_PIPELINE_SOURCE == "web" && $CI_JOB_NAME =~ $DEPLOYMENT_FLAVOR'
  - if: '$CI_PIPELINE_SOURCE == "web"'
    allow_failure: true
    when: manual
  - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_DEPLOYMENTS && $CI_JOB_NAME =~ $DEPLOYMENT_FLAVOR'
    variables:
      APPLY_VALUES_FILE: environment-values/ci/max-pods.yml
      APPLY_WATCH_TIMEOUT_MIN: 40
      WC_APPLY_VALUES_FILE: environment-values/ci/max-pods.yml
      APPLY_WC_WATCH_TIMEOUT_MIN: 40
  - if: $CI_MERGE_REQUEST_LABELS =~ /run-e2e-tests/ && ($E2E_JOB_MR_PARITY == "any" || ($E2E_JOB_MR_PARITY == "even" && $CI_OPEN_MERGE_REQUESTS =~ /[02468]$/) || ($E2E_JOB_MR_PARITY == "odd" && $CI_OPEN_MERGE_REQUESTS =~ /[13579]$/))
  - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    when: manual

.default-trigger:
  stage: deploy
  rules: !reference [".deployment_rules"]
  trigger:
    forward:
      pipeline_variables: true  # required to pass variables from upstream to downstream pipelines
  needs: []

.needs-publish-jobs:
  - job: push-helm-artifacts
  - job: publish-kustomize-units-artifact
  - job: publish-sylva-units-artifact

.default-trigger-oci:
  extends: .default-trigger
  variables:
    OCI_TAG: $OCI_TAG_FORMAT
    KIND_CLUSTER_NAME: bootstrap-${ENV_TAG_OCI}
    MANAGEMENT_CLUSTER_NAME: mgmt-${ENV_TAG_OCI}
    WORKLOAD_CLUSTER_NAME: wc-${ENV_TAG_OCI}
  needs: !reference [.needs-publish-jobs]

capd-preview-deploy:
  stage: deploy
  extends:
    - .deploy-base
  timeout: 15min
  script:
    - !reference [.common-deployment, script_common]
    - !reference [.common-deployment, script_capd]
    - ./preview.sh environment-values/${ENV_NAME}
  artifacts:
    when: on_failure
    expire_in: 1 hour
    paths:
      - debug-on-exit.log
      - bootstrap-cluster-dump/
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - preview.sh
        - tools/shell-lib/common.sh
  variables:
    ENV_NAME: kubeadm-capd

capd-preview-oci-deploy:
  extends: [capd-preview-deploy]
  variables:
    OCI_TAG: $OCI_TAG_FORMAT
    ENV_NAME: kubeadm-capd
  needs: !reference [.needs-publish-jobs]

capd-kubeadm-deploy:
  extends: .default-trigger
  variables:
    E2E_JOB_MR_PARITY: even
    ENV_NAME: kubeadm-capd
  trigger:
    include: .gitlab/ci/pipeline-deploy-kubeadm-capd.yml
    strategy: depend

capd-kubeadm-oci-deploy:
  extends: .default-trigger-oci
  variables:
    E2E_JOB_MR_PARITY: odd
    ENV_NAME: kubeadm-capd
  trigger:
    include: .gitlab/ci/pipeline-deploy-kubeadm-capd.yml
    strategy: depend

capo-kubeadm-deploy:
  extends: .default-trigger
  variables:
    CAPO_TAG: $ENV_TAG
    E2E_JOB_MR_PARITY: even
    ENV_NAME: kubeadm-capo
  trigger:
    include: .gitlab/ci/pipeline-deploy-capo.yml
    strategy: depend

capo-kubeadm-oci-deploy:
  extends: .default-trigger-oci
  variables:
    CAPO_TAG: $ENV_TAG_OCI
    E2E_JOB_MR_PARITY: odd
    ENV_NAME: kubeadm-capo
  trigger:
    include: .gitlab/ci/pipeline-deploy-capo.yml
    strategy: depend

capo-rke2-deploy:
  extends: .default-trigger
  variables:
    CAPO_TAG: $ENV_TAG
    E2E_JOB_MR_PARITY: odd
    ENV_NAME: rke2-capo
  trigger:
    include: .gitlab/ci/pipeline-deploy-capo.yml
    strategy: depend

capo-rke2-oci-deploy:
  extends: .default-trigger-oci
  variables:
    CAPO_TAG: $ENV_TAG_OCI
    E2E_JOB_MR_PARITY: even
    ENV_NAME: rke2-capo
  trigger:
    include: .gitlab/ci/pipeline-deploy-capo.yml
    strategy: depend

capo-misc-units-deploy:
  extends: .default-trigger-oci
  stage: deploy
  variables:
    ENV_NAME: kubeadm-capo
    CAPO_TAG: "${ENV_TAG_OCI}-misc"
    CUSTOM_VALUES_FILE: environment-values/ci/misc-units-in-capo.yml
    MGMT_WATCH_TIMEOUT_MIN: 45
    ONLY_DEPLOY_MGMT: "TRUE"
  trigger:
    include: .gitlab/ci/pipeline-deploy-capo.yml
    strategy: depend

capo-fip-deploy:
  extends: .default-trigger-oci
  variables:
    ENV_NAME: kubeadm-capo
    CAPO_TAG: "${ENV_TAG_OCI}-fip"
    CUSTOM_VALUES_FILE: environment-values/ci/capo-fip.yml
    MGMT_WATCH_TIMEOUT_MIN: 20
    ONLY_DEPLOY_MGMT: "TRUE"
    E2E_JOB_MR_PARITY: none
  trigger:
    include: .gitlab/ci/pipeline-deploy-capo.yml
    strategy: depend

capm3-rke2-virt-equinix-deploy:
  extends: .default-trigger
  variables:
    ENV_NAME: rke2-capm3-virt
    METAL3_PROVIDER: sylva
  trigger:
    include: .gitlab/ci/pipeline-deploy-rke2-capm3-virt-equinix.yml
    strategy: depend

capm3-rke2-virt-equinix-deploy-suse:
  extends: .default-trigger
  variables:
    ENV_NAME: rke2-capm3-virt
    METAL3_PROVIDER: suse
  trigger:
    include: .gitlab/ci/pipeline-deploy-rke2-capm3-virt-equinix.yml
    strategy: depend
