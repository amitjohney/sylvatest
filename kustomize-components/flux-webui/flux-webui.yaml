---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: GitRepository
metadata:
  name: weave-gitops
  namespace: flux-system
spec:
  interval: 10m0s
  gitImplementation: libgit2
  ref:
    #branch: main
    tag: v0.9.6
  #secretRef:
  #  name: https-ca-authority
  url: https://github.com/weaveworks/weave-gitops.git
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: flux-webui
  namespace: flux-system
spec:
  targetNamespace: flux-system
  releaseName: flux-webui
  chart:
    spec:
      chart: charts/gitops-server
      version: "4.0.4"
      sourceRef:
        kind: GitRepository
        name: weave-gitops
        namespace: flux-system
  interval: 1m0s
  install:
    createNamespace: false
  upgrade:
    force: true
  values:
    logLevel: debug
    envVars:
    - name: WEAVE_GITOPS_FEATURE_TENANCY
      value: "true"
    - name: WEAVE_GITOPS_FEATURE_CLUSTER
      value: "false"
    installCRDs: true
    adminUser:
      create: true
      username: admin
      #password: admin
      passwordHash: $2y$10$Nx..RQ9YF/Cw9365MkpcQ.zq1bfpv95uXeWFRPXQPAC3NRVpANX5G
    service:
      type: LoadBalancer
    rbac:
      additionalRules:
        - apiGroups: ["cluster.x-k8s.io"]
          resources: ["clusterclasses", "clusters", "machinedeployments", "machinehealthchecks", "machinepools", "machines", "machinesets"]
          verbs: [ "get", "list" ]
        - apiGroups: ["infrastructure.cluster.x-k8s.io"]
          resources: ["openstackclusters", "openstackclustertemplates", "openstackmachines", "openstackmachinetemplates"]
          verbs: [ "get", "list" ]
        - apiGroups: ["bootstrap.cluster.x-k8s.io"]
          resources: ["kubeadmconfigs", "kubeadmconfigtemplates"]
          verbs: [ "get", "list" ]
        - apiGroups: ["controlplane.cluster.x-k8s.io"]
          resources: ["kubeadmcontrolplanes", "kubeadmcontrolplanetemplates"]
          verbs: [ "get", "list" ]
        - apiGroups: ["*"]
          resources: ["*"]
          verbs: [ "*" ]
    #ingress:
    #  enabled: true
