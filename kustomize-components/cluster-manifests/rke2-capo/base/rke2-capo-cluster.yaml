apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  name: ${CLUSTER_NAME}
  namespace: default
spec:
  clusterNetwork:
    services:
      cidrBlocks: ["10.43.0.0/16"]
    pods:
      cidrBlocks: ["10.42.0.0/16"]
    serviceDomain: cluster.local
  controlPlaneRef:
    apiVersion: controlplane.cluster.x-k8s.io/v1alpha1
    kind: RKE2ControlPlane
    name: ${CLUSTER_NAME}-control-plane
    namespace: default
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha5
    kind: OpenStackCluster
    name: ${CLUSTER_NAME}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha5
kind: OpenStackCluster
metadata:
  name: ${CLUSTER_NAME}
  namespace: default
spec:
  cloudName: capo_cloud
  externalNetworkId: ${CAPO_NETWORK_ID}
  identityRef:
    kind: Secret
    name: management-cluster-cloud-config
  managedSecurityGroups: true
  allowAllInClusterTraffic: true
  disableAPIServerFloatingIP: true
  apiServerLoadBalancer:
    enabled: false
  network:
    id: ${CAPO_NETWORK_ID}
  apiServerFixedIP: ${KUBE_VIP_IP}
---
apiVersion: controlplane.cluster.x-k8s.io/v1alpha1
kind: RKE2ControlPlane
metadata:
  name: ${CLUSTER_NAME}-control-plane
  namespace: default
spec:
  infrastructureTemplate:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha5
    kind: OpenStackMachineTemplate
    name: ${CLUSTER_NAME}-cp-template
    namespace: default
  rke2ConfigSpec:
    files:
    - path: /var/lib/rancher/rke2/server/manifests/ingress.yaml
      owner: "root:root"
      permissions: "0644"
      content: |
          ---
          apiVersion: helm.cattle.io/v1
          kind: HelmChartConfig
          metadata:
            name: rke2-ingress-nginx
            namespace: kube-system
          spec:
            valuesContent: |-
              controller:
                publishService:
                  enabled: true
                service:
                  enabled: true
                  loadBalancerIP: "${KUBE_VIP_IP}"
                  annotations:
                    metallb.universe.tf/allow-shared-ip: "share-vip-${KUBE_VIP_IP}"
    - path: /var/lib/rancher/rke2/server/manifests/metallb.yaml
      owner: "root:root"
      permissions: "0644"
      content: |
          ---
          apiVersion: v1
          kind: Namespace
          metadata:
            name: metallb-system
          ---
          apiVersion: helm.cattle.io/v1
          kind: HelmChart
          metadata:
            name: metallb
            namespace: metallb-system
          spec:
            chart: metallb
            repo: https://metallb.github.io/metallb
            targetNamespace: metallb-system
            tolerations:
            - key: node.cloudprovider.kubernetes.io/uninitialized
              value: "true"
              effect: NoSchedule
            - effect: NoExecute
              key: node-role.kubernetes.io/etcd
            - effect: NoSchedule
              key: node-role.kubernetes.io/master
            - effect: NoSchedule
              key: node-role.kubernetes.io/control-plane
            nodeSelector:
              node-role.kubernetes.io/control-plane: "true"
            valuesContent: |-
              controller.nodeSelector:
                node-role.kubernetes.io/control-plane: "true"
              controller.tolerations:
                - key: node.cloudprovider.kubernetes.io/uninitialized
                  value: "true"
                  effect: NoSchedule
                - effect: NoExecute
                  key: node-role.kubernetes.io/etcd
                - effect: NoSchedule
                  key: node-role.kubernetes.io/master
                - effect: NoSchedule
                  key: node-role.kubernetes.io/control-plane
          ---
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            name: lbpool
            namespace: metallb-system
          spec:
            addresses:
              - ${KUBE_VIP_IP}/32
          ---
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
            name: l2advertisement
            namespace: metallb-system
          spec:
            ipAddressPools:
            - lbpool
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: kubernetes-vip
            namespace: kube-system
            annotations:
              metallb.universe.tf/allow-shared-ip: "share-vip-${KUBE_VIP_IP}"
          spec:
            type: LoadBalancer
            loadBalancerIP: ${KUBE_VIP_IP}
            ports:
            - name: https
              port: 6443
              protocol: TCP
              targetPort: 6443
            - name: rancher
              port: 9345
              protocol: TCP
              targetPort: 9345
            selector:
              component: kube-apiserver
    serverConfig:
      tlsSan:
      - localhost
      - 127.0.0.1
      - 0.0.0.0
    agentConfig:
      kubeletArgs:
        - "provider-id=openstack://{{ ds.meta_data.uuid }}"
    deployRKE2Commands:
      - "echo 'cni: calico' >> /etc/rancher/rke2/config.yaml"
      - systemctl daemon-reload
      - systemctl enable rke2-server.service
      - systemctl start rke2-server.service
      - ln -s /var/lib/rancher/rke2/bin/kubectl /usr/local/bin/kubectl
  replicas: 3
  version: v1.24.4+rke2r1
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha5
kind: OpenStackMachineTemplate
metadata:
  name: ${CLUSTER_NAME}-cp-template
  namespace: default
spec:
  template:
    spec:
      cloudName: capo_cloud
      flavor: m1.large
      identityRef:
        kind: Secret
        name: management-cluster-cloud-config
      image: ${MACHINE_IMAGE}
      sshKeyName: ${SSH_KEY_NAME}
      securityGroups:
        - name: default
      ports:
      - network:
          id: ${CAPO_NETWORK_ID}
        allowedAddressPairs:
          - ipAddress: ${KUBE_VIP_IP}

