apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

patches:
- target:
    kind: KubeadmControlPlane
  patch: |-
    - op: add
      path: /spec/kubeadmConfigSpec/files/-
      value:
        path: /etc/containerd/config.toml
        owner: root
        permissions: "0644"
        content: |
          # Use config version 2 to enable new configuration fields.
          # Config file is parsed as version 1 by default.
          version = 2

          imports = ["/etc/containerd/conf.d/*.toml"]

          [plugins]
            [plugins."io.containerd.grpc.v1.cri"]
              sandbox_image = "k8s.gcr.io/pause:3.6"
            [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
              runtime_type = "io.containerd.runc.v2"
            [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
              SystemdCgroup = true

    - op: add
      path: /spec/kubeadmConfigSpec/files/-
      value:
        path: /etc/containerd/conf.d/registry.toml
        owner: root
        permissions: "0644"
        content: |
          [plugins."io.containerd.grpc.v1.cri".registry.mirrors]
            [plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]
              endpoint = ["${REGISTRY_MIRROR}"]

          # Enable registry.k8s.io as the primary mirror for k8s.gcr.io
          # See: https://github.com/kubernetes/k8s.io/issues/3411
          [plugins."io.containerd.grpc.v1.cri".registry.mirrors."k8s.gcr.io"]
            endpoint = ["https://registry.k8s.io", "https://k8s.gcr.io",]

    - op: add
      path: /spec/kubeadmConfigSpec/preKubeadmCommands
      value:
        - systemctl daemon-reload
        - systemctl restart containerd.service
